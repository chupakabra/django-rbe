{%  extends 'base.html' %}

{% block header %}
    <link href="/static/css/inventory.css" rel="stylesheet">
    <link href="/static/css/timeline.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
{% endblock %}


{% block content %}


<style>

.qrcode img {
    width: 100%;
    height: auto;

}

.qrcode {
    text-align: center;
    padding: 10px;
    margin-bottom: 10px;
    margin-top: 20px;
}

.centered .title {
    text-align: center;
    font-size: 24px;
}

.space-top {
    margin-top: 20px;
}

.profile {
    min-height: 0;
}
.well {
    margin-bottom: 0;
}

.text-right {
    text-align: right;
}

.text-left{
    text-align: left;
}

hr {
  border-color: #aaa;
}
</style>

<body>


<div class="container">
	<div class="row">
		<div class="col-md-offset-2 col-md-8 col-lg-offset-3 col-lg-6">
    	 <div class="well profile">
            <div class="col-sm-12">
                <div class="row">
                    <h2>{{object.title}}</h2>
                </div>
                <div class="row">
                    <div class="col-xs-12 col-sm-8">
                        <p><strong>About: </strong> {{object.description}} </p>
                        <p><strong>Transportable: </strong>
                            {% if object.transport %}
                                Yes
                            {% else %}
                                No
                            {% endif %}
                        </p>
                        <p><strong>Entered by: </strong> {{object.entered_by}}</p>
                        <p><strong>Submitted: </strong> {{object.registration_date}}</p>
                        <p id="tags"><strong>Tags: </strong>
                            {% for element in object.tags.all %}
                                <span onclick="del_tag(this)" id="{{ element.id }}" class="tags">{{ element.value }}</span>
                            {% endfor %}
                        </p>
                        <p><strong>Add tags: </strong>
                            <input id='add_tags' type="text"/>
                        </p>

                    </div>
                    <div class="col-xs-6 col-sm-4 text-center" style="vertical-align: middle">
                            <div class="qrcode" style="width: auto;" id='qr_code_{{ object.unique_identifier }}'></div>
                            <script> new QRCode(document.getElementById("qr_code_{{ object.unique_identifier }}"), "{{ object.unique_identifier }}");</script>
                    </div>
                </div>
            </div>

            <div class="row divider text-center" style="margin-top: 3em">
                <div class="col-xs-12 col-sm-4">
                    <button class="btn btn-success btn-block"><span class="fa fa-plus-circle"></span> Add Photo</button>
                </div>
                <div class="col-xs-12 col-sm-4">
                    <button class="btn btn-info btn-block"><span class="fa fa-calendar"></span> Request Usage </button>
                </div>
                <div class="col-xs-12 col-sm-4">
                    <div class="btn-group dropdown btn-block">
                      <button type="button" class="btn btn-primary btn-block dropdown-toggle" data-toggle="dropdown"><span class="fa fa-gear"></span>
                          Other
                          <span class="caret"></span>
                      </button>
                      <ul class="dropdown-menu text-left" role="menu">
                          <li><a id="remark-btn" href="#"><span class="fa fa-comment pull-right"></span>Add remark</a></li>
                          <li class="divider"></li>
                          <li><a href="#"><span class="fa fa-chain-broken pull-right"></span> Mark object broken</a></li>
                          <li><a href="#"><span class="fa fa-pie-chart pull-right"></span>Show statistics</a></li>
                      </ul>
                    </div>
                </div>
            </div>
            <hr>
            <div id="remark_section" class="row divider text-center" style="display: none">
                <div class="col-xs-12 col-sm-12 text-left">
                    <h3>Comment</h3>
                </div>
                <div class="col-xs-12 col-sm-12">
                    <textarea id='remark-area' style="width: 100%; resize: none;" rows="4"  maxlength="250"></textarea>
                </div>
                <div class="col-xs-12 col-sm-4 col-sm-offset-8 text-right">
                    <button id='submit-remark' class="btn btn-primary btn-block">Submit</button>
                </div>
            </div>
    	 </div>
		</div>
	</div>
</div>


<div class="container">
    <div class="page-header">
        <h2>Timeline</h2>
    </div>

    <!-- Timeline -->
    <div class="timeline">
        <div id="timeline-prepend" class="line text-muted"></div>

        {% autoescape off %}
            {% for event in events %}
                {{ event.render }}
            {% endfor %}
        {% endautoescape %}

        {% if events|length == 0 %}
            <article class="panel panel-info panel-outline">
                <div class="panel-heading icon">
                    <i class="glyphicon glyphicon-info-sign"></i>
                </div>

                <div class="panel-heading">
                    <h2 class="panel-title"></h2>
                </div>

                <div class="panel-body">
                    <strong>{{ object.registration_date|date:'Y-m-d, H:i:s'}}</strong> Object created
                </div>
            </article>
        {% endif %}
    </div>
</div>
<div style="display: none" id="object_id">{{ object.unique_identifier }}</div>

<script>

     function del_tag(element){
        var tag_id = $(element).attr('id');
        $.ajax({
            method: 'POST',
            url: '{% url "del_tag" %}',
            data: {
                object_id: $('#object_id').html(),
                tag_id: tag_id,
                csrfmiddlewaretoken: get_csrf_token()
            }
        }).done(function(msg) {
            if (msg['success']){
                $("#tags").find('#' + tag_id).remove();
                add_to_timeline(msg['timeline_html']);
          }
        });
    }

    function add_tag(tag_value){
        $.ajax({
            method: 'POST',
            url: '{% url "add_tag" %}',
            data: {
                object_id: $('#object_id').html().trim().toLowerCase(),
                value: tag_value,
                csrfmiddlewaretoken: get_csrf_token()
            }
        }).done(function(msg) {
            if (msg['success']){
                var id = msg['id'];
                var e = $('<span></span>');
                $(e).addClass('tags');
                $(e).attr('id', id);
                $(e).attr('onclick', 'del_tag(this)');
                $(e).html(tag_value);
                $("#tags").append(e);
                add_to_timeline(msg['timeline_html']);
          }
        });
    }

    function add_to_timeline(html_code){
        var f = $(html_code);
        f.hide();
        $('#timeline-prepend').after(f);
        f.show(700);
    }

    $(document).ready(function() {
        $('#add_tags').bind('keyup', function (e) {
            if (e.keyCode == 13) {
                e.preventDefault();
                var text = $(this).val();
                add_tag(text);
                $(this).val('');
            }
        });

        $('#remark-btn').click(function(e){
            e.preventDefault();
            $('#remark_section').show(700);
        });

        $('#submit-remark').click(function(){
            var comment_text = $('#remark-area').val();
            $.ajax({
                method: 'POST',
                url: '{% url "submit_comment" %}',
                data: {
                    object_id: $('#object_id').html(),
                    comment_text: comment_text,
                    csrfmiddlewaretoken: get_csrf_token()
                }
            }).done(function(msg) {
                if (msg['success']){
                    $('#remark_section').hide(700);
                    add_to_timeline(msg['timeline_html']);
                } else {
                    swal('Cancelled', 'Your imaginary file is safe :)', 'error');
                }
            });
        });
    });
</script>



</body>

{% endblock %}